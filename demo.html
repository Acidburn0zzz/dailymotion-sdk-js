<!DOCTYPE html>
<html>
<head>
<script src="src/third-party/json2.js"></script>

<script src="src/core/prelude.js"></script>
<script src="src/core/json.js"></script>

<script src="src/common/array.js"></script>

<script src="src/core/cookie.js"></script>
<script src="src/core/event.js"></script>
<script src="src/core/init.js"></script>
<script src="src/core/qs.js"></script>
<script src="src/core/api.js"></script>
<script src="src/core/auth.js"></script>

<script src="http://ajax.microsoft.com/ajax/jquery/jquery-1.4.4.min.js"></script>
<script src="http://ajax.microsoft.com/ajax/jquery.templates/beta1/jquery.tmpl.min.js"></script>
<script src="http://code.jquery.com/mobile/1.0a2/jquery.mobile-1.0a2.min.js"></script>

<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0a2/jquery.mobile-1.0a2.min.css">
</head>
<body>
<script id="video-item" type="text/x-jquery-tmpl">
<li><img src="${thumbnail_small_url}"><a href="#video/${id}">${title}</a>
</script>

<script id="video-page" type="text/x-jquery-tmpl">
<div data-role="header"><h1>${title}</h1></div>
<div data-role="content">
    {{html embed_html}}
</div>
</script>

<script id="video-page-loading" type="text/x-jquery-tmpl">
<div data-role="header"><h1>Loading...</h1></div>
<div data-role="content"></div>
</script>

<div data-role="page">
    <div data-role="header">
        <h1 id="main-title">Dailymotion</h1>
        <a href="#" id="search-button" data=role="button" class="ui-btn-right">Search</a>
        <div id="nav" data-role="navbar">
            <ul>
                <li><a href="#" endpoint="/videos?filters=featured&amp;localization=detect">Featured</a>
                <li><a href="#" endpoint="/videos/favorites" requires-auth="true">Favorites</a>
                <li><a href="#" endpoint="/videos/subscriptions" requires-auth="true">Subscriptions</a>
                <li><a href="#" endpoint="/videos/uploaded" requires-auth="true">My Videos</a>
            </ul>
        </div>
    </div>
    <div data-role="content">
        <div id="search"><form class="ui-listview-filter ui-bar-c" role="search"><input data-type="search" placeholder="Search"><form></div>
        <ul data-role="listview" id="video-list"></ul>
        <br>
        <a href="#" id="load-more" data-role="button">Load More</a>
    </div>
</div>

<script>
var videoFields = 'id,thumbnail_small_url,title,url,embed_html';
var currentVideoListEndpoint = null;
var currentVideoListPage = 0;

function showVideo(videoId, data)
{
    if ($('#video/' + videoId).length > 0)
    {
        return;
    }

    var page = $('<div data-role="page">').attr('id', 'video/' + videoId).appendTo($('body'));
    if (data)
    {
        $('#video-page').tmpl(data).appendTo(page);
    }
    else
    {
        $('#video-page-loading').tmpl().appendTo(page);
        DM.api('/video/' + videoId, {fields:videoFields}, function(videoInfo)
        {
            var content = $('#video-page').tmpl(videoInfo);
            page.html(content);
            content.page();
        });
    }
}

function loadMoreVideos()
{
    if ($.type(currentVideoListEndpoint) != 'string')
    {
        return;
    }
    $.mobile.pageLoading();
    var sep = (currentVideoListEndpoint.indexOf('?') > -1 ? '&' : '?');
    DM.api(currentVideoListEndpoint + sep + 'limit=20&page=' + ++currentVideoListPage, {fields:videoFields}, function(videos)
    {
        $.mobile.pageLoading(true);
        if ('list' in videos)
        {
            var videoList = $('#video-list');
            $('#video-item').tmpl(videos.list).appendTo(videoList);
            videoList.listview('refresh');
            $('ul div.ui-btn-inner').css('min-height', '38px');
            if (videos.has_more)
            {
                $('#load-more').show();
            }
            else
            {
                $('#load-more').hide();
            }
        }
    });
}

function showVideoList(endpoint, requiresAuth)
{
    if (!endpoint)
    {
        // no arg == reload current
        endpoint = currentVideoListEndpoint;
        if (!endpoint)
        {
            return;
        }
    }
    currentVideoListEndpoint = endpoint;
    currentVideoListPage = 0;

    $('#nav a').each(function(index, item)
    {
        if ($(item).attr('endpoint').replace(/.*#/, '') == endpoint)
        {
            $(item).addClass('ui-btn-active');
        }
        else
        {
            $(item).removeClass('ui-btn-active');
        }
    });
    $('#video-list').empty();
    $('#load-more').hide();
    $.mobile.pageLoading();

    if (requiresAuth && !DM.getSession())
    {
        DM.login(function(response)
        {
            if (response.session)
            {
                loadMoreVideos();
            }
            else
            {
                $.mobile.pageLoading(true);
            }
        });
    }
    else
    {
        loadMoreVideos();
    }
}

function route(href, data)
{
    if (href.indexOf('#video/') == 0)
    {
        showVideo(href.replace(/^#video\//, ''), data);
    }
}

$('ul').delegate('a', 'click', function(e)
{
    route($(this).attr('href'), $(this).tmplItem().data);
});


$('div').live('pagebeforehide',function(event, ui)
{
    // Prevent from ghost flash player bug
    $('iframe', $.mobile.activePage).remove();
});

DM.init({apiKey: '16bb2ca3b5735b541a91', cookie: true});
DM.Event.subscribe('auth.sessionChange', function() {showVideoList();}); // reload
$(function()
{
    showVideoList($('#nav a').first().attr('endpoint'));
    $('#nav').delegate('a', 'click', function()
    {
        showVideoList($(this).attr('endpoint'), $(this).attr('requires-auth') == 'true');
    });
    $('#load-more').click(loadMoreVideos);
    $('#search form').submit(function(e)
    {
        showVideoList('/videos?search=' + $('input', this).val());
        e.preventDefault();
    });
    $('#search').hide();
    $('#search-button').click(function()
    {
        $('#search').toggle();
        $('#nav').toggle();
        $('#search:visible input').focus()
    });
});
</script>
</body>
</html>